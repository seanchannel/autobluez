#!/usr/bin/env expect-lite

*LOG $EL_log
@$EL_timeout

; === Connect to $EL_pod for $0 ===
>screen gatttool -I --listen -b $EL_address
*/[$EL_address][LE]>/
-<Usage
>>^A
>H
<logfile
>connect
-<Error
-<connect error
<Connection successful
>>^A
>^D
>

# save screen id
>screen -list | grep pts | sort | head -1
+$myscreen=([0-9]+\.pts.[0-9]+.[a-z\- 0-9]+)

>>. ~/.bashrc

##------------------------------------------------------------------##

; ============ Test "get volt" ============
>rm $EL_SCREENLOG
>echo -n "get volt" | xxd -ps
+$cmd=\n(.*)
>screen -r $myscreen
>char-write-req 0x001b $cmd
<Characteristic value was written successfully
<Notification
>>^A
>^D
>
:2
; ============ Verify "get volt" e.g. "Vbat =  5.67" ============
>dehex $EL_SCREENLOG
-<Please try again
-<Unknown
<Vbat

##------------------------------------------------------------------##

; ============ Test "get time" ============
>rm $EL_SCREENLOG
>echo -n "get time" | xxd -ps
+$cmd=\n(.*)
>screen -r $myscreen
>char-write-req 0x001b $cmd
<Notification
>>^A
>^D
>

; ============ Verify "get time" e.g. "UTC time: 17:53:47" ============
>dehex $EL_SCREENLOG
-<Please try again
-<Unknown
<UTC time

##------------------------------------------------------------------##

; ============ Test "get date" ============
>rm $EL_SCREENLOG
>echo -n "get date" | xxd -ps
+$cmd=\n(.*)
>screen -r $myscreen
>char-write-req 0x001b $cmd
<Notification
>>^A
>^D
>

; ============ Verify "get date" e.g. "UTC date: 2018/10/02" ============
>dehex $EL_SCREENLOG
-<Please try again
-<Unknown
<UTC date

; ============ Cleanup ============
>>rm $EL_SCREENLOG
>screen -r $myscreen
>>^A
>h
>^D
#>>screen -S $myscreen -X stuff 'exit\015'
