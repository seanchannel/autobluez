#!/usr/bin/env expect-lite

~tests/connect.inc
*~../cleanup.inc
$result=FAIL


; -+-+-+-> WaterGuru $EL_pod $EL_testname: Test temperature current 9-10mA
$testitem=tempCurrent
$testcond=0
$testvalue=10mA

>screen -r $EL_testname -S -X stuff "char-write-req 0x001b `echo -n get temp | xxd -ps`\015"
>
:3
>dehex $EL_BLELOG
<water temp = [1-9][0-9]*\.[0-9]
>tail -10 $EL_POWERLOG
<0.0[0-1][09][0-9]
# XXX this will also match all-zero. need proper comparison here.


; -+-+-+-> WaterGuru $EL_pod $EL_testname: Test version current 60-69mA
$testitem=versionCurrent
$testcond=0
$testvalue=60mA

>screen -r $EL_testname -S -X stuff "char-write-req 0x001b `echo -n version | xxd -ps`\015"
>
:2
>dehex $EL_BLELOG
<TI_VERS = $EL_fw_bleversion
<$EL_fw_version
>tail -10 $EL_POWERLOG
<0.06


; -+-+-+-> WaterGuru $EL_pod $EL_testname: Test pad motor current ~300-399mA
$testitem=padMotorCurrent
$testcond=0
$testvalue=399mA

>screen -r $EL_testname -S -X stuff "char-write-req 0x001b `echo -n pad dist 10000 | xxd -ps`\015"
>
:30
>dehex $EL_BLELOG
<vbat =
<retcode =
<mAs=
>tail -60 $EL_POWERLOG 
>tail -60 $EL_POWERLOG | egrep -c '0\.3'
<[3-4][0-9]


; -+-+-+-> WaterGuru $EL_pod $EL_testname: Test RGB current ~20mA
$testitem=RGBCurrent
$testcond=0
$testvalue=21mA

>screen -r $EL_testname -S -X stuff "char-write-req 0x001b `echo -n 820B46FF | xxd -ps`\015"
>
:25
>screen -r $EL_testname -S -X stuff "char-write-req 0x001b `echo -n 80 | xxd -ps`\015"
>
:5
>dehex $EL_BLELOG
<EXECUTED 0x820B46FF
>tail -60 $EL_POWERLOG 
>tail -60 $EL_POWERLOG | egrep -c '0\.02'
<[2-3][0-9]

# static overall pass log
$result=PASS
~tests/cleanup.inc result=PASS testitem=all testcond=current testvalue=mA

